<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />

  <script type="text/javascript" src="roslib.min.js"></script>
  <script type="text/javascript" src="js-yaml.min.js"></script>
  <script type="text/javascript" src="FileSaver.js"></script>
  <link rel="stylesheet" type="text/css" href="./index.css">

  <script type="text/javascript" type="text/javascript">
    var ros = new ROSLIB.Ros({
      url: 'ws://localhost:9090'
    });

    var chairs = ['1', '3', '4']
    var live_status = new Map();
    chairs.map(chair => live_status.set(chair, null))
    console.log(live_status)

    ros.on('connection', function () {
      document.getElementById("status").innerHTML = "Connected";
    });

    ros.on('error', function (error) {
      document.getElementById("status").innerHTML = "Error";
    });

    ros.on('close', function () {
      document.getElementById("status").innerHTML = "Closed";
    });

    var txt_listener = new ROSLIB.Topic({
      ros: ros,
      name: '/from_hub_receiver',
      messageType: 'std_msgs/String'
    });

    getTextForStatus = function(status) {
      if (status == 'r') {
        return "READY";
      }
      else if (status == 'e') {
        return "EXCLUDE";
      }
      else if (status == 's') {
        return "SUCCESS";
      }
      else if (status == 'f') {
        return "FAILURE";
      }
      else if (status == 'o' || status == null) {
        return "OFFLINE";
      }
      else {
        return "ERROR: " + status;
      }
    }

    function updateChairStatus(key, status) {
      let element = document.getElementById(key + "status");
        if (element) {
          element.innerHTML = getTextForStatus(status)
          element.classList.remove(...element.classList);
          element.classList.add("status", status);
        }
    };

    txt_listener.subscribe(function (m) {
      // console.log(m, m.length, chairs.includes(m.data[0]));
      if (m.data.length == 2 && chairs.includes(m.data[0])) {
        live_status.set(m.data[0], m.data[1]);
        document.getElementById("msg").innerHTML = m.data;
        updateChairStatus(m.data[0], m.data[1]);
      }
    });

    function checkStatus() {
      for (let [key, value] of live_status) {
        if (value == null) {
          updateChairStatus(key, 'o');
        }
        live_status.set(key, null);
      }
      setTimeout(checkStatus, 5000);
    };

    checkStatus();

    hub_dir_listener = new ROSLIB.Topic({
      ros: ros,
      name: "/from_hub",
      messageType: 'std_msgs/String'
    });

    submitForm = function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const formProps = Object.fromEntries(formData);
      
      const cmd = formProps.custom_handwritten;

      if (cmd.length == 8 &&
         (cmd[0] == 'f' || cmd[0] == 'r') &&
         (cmd[1] >= '0' && cmd[1] <= '9') &&
         (cmd[2] == '.') &&
         (cmd[3] >= '0' && cmd[3] <= '9') &&
         (cmd[4] == 'f' || cmd[4] == 'r') &&
         (cmd[5] >= '0' && cmd[5] <= '9') &&
         (cmd[6] = '.') &&
         (cmd[7] >= '0' && cmd[7] <= '9')
         ) {
          hub_dir_listener.publish(formatMsg(e.target.id[0], formProps.custom_handwritten));
          document.getElementById(e.target.id).reset();
      }
      else {
        alert("Custom commands must be 8 characters: [f/r][#.#][f/r][#.#]\nExample: f1.0f1.0")
      }

    }

    move = function () {
      var dir = new ROSLIB.Message({
        data: "hello"
      });
      hub_dir_listener.publish(dir);
    }

    formatMsg = function (id, msg) {
      return new ROSLIB.Message({
        data: id + msg
      });
    }

    toggle = function (id) {
      hub_dir_listener.publish(formatMsg(id, "toggle"));
    }
    stop = function (id) {
      hub_dir_listener.publish(formatMsg(id, "stop"));
    }
    start = function (id) {
      hub_dir_listener.publish(formatMsg(id, "start"));
    }
    fwd = function (id) {
      hub_dir_listener.publish(formatMsg(id, "fwd"));
    }
    ffwd = function (id) {
      hub_dir_listener.publish(formatMsg(id, "ffwd"));
    }
    bwd = function (id) {
      hub_dir_listener.publish(formatMsg(id, "bwd"));
    }
    fbwd = function (id) {
      hub_dir_listener.publish(formatMsg(id, "fbwd"));
    }
    veerl = function (id) {
      hub_dir_listener.publish(formatMsg(id, "veerl"));
    }
    veerr = function (id) {
      hub_dir_listener.publish(formatMsg(id, "veerr"));
    }
    pivotl = function (id) {
      hub_dir_listener.publish(formatMsg(id, "pivotl"));
    }
    pivotr = function (id) {
      hub_dir_listener.publish(formatMsg(id, "pivotr"));
    }


    function switchscreen(newScreenId) {
  var liveScreen = document.getElementById('live');
  var configScreen = document.getElementById('config');
  if (newScreenId == 'live') {
    configScreen.style.display = "none";
    liveScreen.style.display = "block";
  } else {
    liveScreen.style.display = "none";
    configScreen.style.display = "block";
  }
    }

    function renderJSON(obj) {
    'use strict';
    var keys = [],
        retValue = "";
    for (var key in obj) {
        if (typeof obj[key] === 'object') {
            retValue += "<div class='tree'>" + key;
            retValue += renderJSON(obj[key]);
            retValue += "</div>";
        } else {
            retValue += "<div class='tree'>" + key + " = " + obj[key] + "</div>";
        }

        keys.push(key);
    }
    console.log(retValue);
    return retValue;
}


    openYaml = function(e) {
      console.log("OPENING YAML");
      e.preventDefault();
      console.log(e.target);
      const formData = new FormData(e.target);
      const formProps = Object.fromEntries(formData);
      
      const file = formProps.configFile;
      let ymlcontents = null;

      const reader = new FileReader();
      reader.addEventListener('load', (event) => {
        // event.target.result;
        ymlcontents = event.target.result.replace(/\r/g, "\n");
        // alert(ymlcontents);
        console.log(ymlcontents);

        document.getElementById("ymlTextArea").innerHTML = ymlcontents;
        
        const doc = jsyaml.load(ymlcontents);
        console.log(doc);

        // document.getElementById('ymlContainer').insertAdjacentHTML('beforeend', renderJSON(doc));
      });
      reader.readAsText(file);
    }

    saveYaml = function(e) {
      console.log("SAVING YAML");
      e.preventDefault();

      const textToSave = document.getElementById("ymlTextArea").innerHTML
      const filename = document.getElementById("configFile").files.item(0).name;

      var blob = new Blob([textToSave], {type: "text/plain;charset=utf-8"});
      saveAs(blob, filename);
    }

    sendYaml = function() {
      const textToSend = document.getElementById("ymlTextArea").innerHTML
      hub_dir_listener.publish(formatMsg('0', textToSend));
    }

  </script>
</head>

<body>
  <h1>Anonymous Autonomous</h1>
  <p>Connection status: <span id="status">NOT CONNECTED</span></p>
  <p>Last chair status received: <span id="msg"></span></p>
  <div class="screen" id="live">
  <button onclick="stop('0')" class="stop">STOP ALL</button>
  <button onclick="toggle('0')" class="auto">AUTO ALL</button>

  <div class="statuses">
    <div class="chair_monitor" id="1">
      <h2>Chair 1</h2>
      <div class="status o" id="1status">
        OFFLINE
      </div>
      <br>
      <div class="chair_control">
        <div class="directions">
          <button class="auto" id="1" onclick="toggle(this.id)">AUTO</button>
          <br>
          <button id="1" onclick="ffwd(this.id)">â¤Š</button>
          <div>
            <button id="4" onclick="veerl(this.id)">â¬‰</button>
            <button id="4" onclick="fwd(this.id)">â†‘</button>
            <button id="4" onclick="veerr(this.id)">â¬ˆ</button>
          </div>
          <div>
            <button id="1" onclick="pivotl(this.id)">âŸ²</button>
            <button id="1" onclick="stop(this.id)">ðŸ›‘</button>
            <button id="1" onclick="pivotr(this.id)">âŸ³</button>
          </div>
          <button id="1" onclick="bwd(this.id)">â†“</button>
          <button id="1" onclick="fbwd(this.id)">â¤‹</button>
        </div>
        <br>
        <!-- <button id="1" onclick="start(this.id)">START</button>
        <button id="1" onclick="stop(this.id)" class="stop">STOP</button> -->
        <br>
        <form id="1custom_handwritten" class="handwritten_form" onsubmit="return submitForm(event);">
          <label for="custom_handwritten">Custom: </label>
            <input type="text" id="custom_handwritten" name="custom_handwritten" size="10">
            <button type="submit" class="submit_button">Send</button>
          </form>
      </div>
    </div>
    <div class="chair_monitor" id="3">
      <h2>Chair 3</h2>
      <div class="status o" id="3status">
        OFFLINE
      </div>
      <br>
      <div class="chair_control">
        <div class="directions">
          <button class="auto" id="3" onclick="toggle(this.id)">AUTO</button>
          <br>
          <button id="3" onclick="ffwd(this.id)">â¤Š</button>
          <div>
            <button id="4" onclick="veerl(this.id)">â¬‰</button>
            <button id="4" onclick="fwd(this.id)">â†‘</button>
            <button id="4" onclick="veerr(this.id)">â¬ˆ</button>
          </div>
          <div>
            <button id="3" onclick="pivotl(this.id)">âŸ²</button>
            <button id="3" onclick="stop(this.id)">ðŸ›‘</button>
            <button id="3" onclick="pivotr(this.id)">âŸ³</button>
          </div>
          <button id="3" onclick="bwd(this.id)">â†“</button>
          <button id="3" onclick="fbwd(this.id)">â¤‹</button>
        </div>
        <br>
        <!-- <button id="3" onclick="start(this.id)">START</button>
        <button id="3" onclick="stop(this.id)" class="stop">STOP</button> -->
        <br>
        <form id="3custom_handwritten" class="handwritten_form" onsubmit="return submitForm(event);">
          <label for="custom_handwritten">Custom: </label>
            <input type="text" id="custom_handwritten" name="custom_handwritten" size="10">
            <button type="submit" class="submit_button">Send</button>
          </form>
      </div>
    </div>
    <div class="chair_monitor" id="4">
      <h2>Chair 4</h2>
      <div class="status o" id="4status">
        OFFLINE
      </div>
      <br>
      <div class="chair_control">
        <div class="directions">
          <button class="auto" id="4" onclick="toggle(this.id)">AUTO</button>
          <br>
          <button id="4" onclick="ffwd(this.id)">â¤Š</button>
          <div>
            <button id="4" onclick="veerl(this.id)">â¬‰</button>
            <button id="4" onclick="fwd(this.id)">â†‘</button>
            <button id="4" onclick="veerr(this.id)">â¬ˆ</button>
          </div>
          <div>
            <button id="4" onclick="pivotl(this.id)">âŸ²</button>
            <button id="4" onclick="stop(this.id)">ðŸ›‘</button>
            <button id="4" onclick="pivotr(this.id)">âŸ³</button>
          </div>
          <button id="4" onclick="bwd(this.id)">â†“</button>
          <button id="4" onclick="fbwd(this.id)">â¤‹</button>
        </div>
        <br>
        <!-- <button id="4" onclick="start(this.id)">START</button>
        <button id="4" onclick="stop(this.id)" class="stop">STOP</button> -->
        <br>
        <form id="4custom_handwritten" class="handwritten_form" onsubmit="return submitForm(event);">
          <label for="custom_handwritten">Custom: </label>
            <input type="text" id="custom_handwritten" name="custom_handwritten" size="10">
            <button type="submit" class="submit_button">Send</button>
          </form>
      </div>
    </div>
    <!-- <div class="chair_monitor backup" id="backup">
      <h2>Chair 4 (backup)</h2>
      <div class="status offline">
        OFFLINE
      </div>
    </div> -->
  </div>
  <button onclick="switchscreen('config')" class="switchscreen" id="toConfigScreen">switch to configuration mode</button>

</div>
<div class="screen" id="config" style="display:none">

  <div>
    <form id="openYaml" onsubmit="return openYaml(event);">

  <label for="configFile">Select config file:</label>
  <input type="file"
       id="configFile" name="configFile"
       accept=".yaml">
       <button type="submit">Open</button>
      </form>
    
  </div>
  <div id="ymlContainer"></div>
  <form id="saveYamlForm" onsubmit="return saveYaml(event);">
    <textarea id="ymlTextArea"></textarea>
  <button type="submit">Save</button>
</form>
<button id="sendYaml" onclick="return sendYaml();">Send</button>


  <button onclick="switchscreen('live')" class="switchscreen" id="toLiveScreen">switch to live mode</button>

</div>

</div>
</body>

</html>
