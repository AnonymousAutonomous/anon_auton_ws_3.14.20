<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
  <link rel="stylesheet" type="text/css" href="./index.css">

  <script type="text/javascript" type="text/javascript">
    var ros = new ROSLIB.Ros({
      url: 'ws://localhost:9090'
    });

    var chairs = ['1', '3', '4']
    var live_status = new Map();
    chairs.map(chair => live_status.set(chair, null))
    console.log(live_status)

    ros.on('connection', function () {
      document.getElementById("status").innerHTML = "Connected";
    });

    ros.on('error', function (error) {
      document.getElementById("status").innerHTML = "Error";
    });

    ros.on('close', function () {
      document.getElementById("status").innerHTML = "Closed";
    });

    var txt_listener = new ROSLIB.Topic({
      ros: ros,
      name: '/from_hub_receiver',
      messageType: 'std_msgs/String'
    });

    getTextForStatus = function(status) {
      if (status == 'r') {
        return "READY";
      }
      else if (status == 'e') {
        return "EXCLUDE";
      }
      else if (status == 's') {
        return "SUCCESS";
      }
      else if (status == 'f') {
        return "FAILURE";
      }
      else if (status == 'o' || status == null) {
        return "OFFLINE";
      }
      else {
        return "ERROR: " + status;
      }
    }

    function updateChairStatus(key, status) {
      let element = document.getElementById(key + "status");
        if (element) {
          element.innerHTML = getTextForStatus(status)
          element.classList.remove(...element.classList);
          element.classList.add("status", status);
        }
    };

    txt_listener.subscribe(function (m) {
      // console.log(m, m.length, chairs.includes(m.data[0]));
      if (m.data.length == 2 && chairs.includes(m.data[0])) {
        live_status.set(m.data[0], m.data[1]);
        document.getElementById("msg").innerHTML = m.data;
        updateChairStatus(m.data[0], m.data[1]);
      }
    });

    function checkStatus() {
      for (let [key, value] of live_status) {
        if (value == null) {
          updateChairStatus(key, 'o');
        }
        live_status.set(key, null);
      }
      setTimeout(checkStatus, 5000);
    };

    checkStatus();

    hub_dir_listener = new ROSLIB.Topic({
      ros: ros,
      name: "/from_hub",
      messageType: 'std_msgs/String'
    });

    submitForm = function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const formProps = Object.fromEntries(formData);
      
      const cmd = formProps.custom_handwritten;

      if (cmd.length == 8 &&
         (cmd[0] == 'f' || cmd[0] == 'r') &&
         (isdigit(cmd[1])) &&
         (cmd[2] == '.') &&
         (isdigit(cmd[3])) &&
         (cmd[4] == 'f' || cmd[4] == 'r') &&
         (isdigit(cmd[5])) &&
         (cmd[6] = '.') &&
         (isdigit(cmd[7]))
         ) {
          hub_dir_listener.publish(formatMsg(e.target.id[0], formProps.custom_handwritten));
          document.getElementById(e.target.id).reset();
      }
      else {
        alert("Custom commands must be 8 characters: [f/r][#.#][f/r][#.#]\nExample: f1.0f1.0")
      }

    }

    move = function () {
      var dir = new ROSLIB.Message({
        data: "hello"
      });
      hub_dir_listener.publish(dir);
    }

    formatMsg = function (id, msg) {
      return new ROSLIB.Message({
        data: id + msg
      });
    }

    toggle = function (id) {
      hub_dir_listener.publish(formatMsg(id, "toggle"));
    }
    stop = function (id) {
      hub_dir_listener.publish(formatMsg(id, "stop"));
    }
    start = function (id) {
      hub_dir_listener.publish(formatMsg(id, "start"));
    }
    fwd = function (id) {
      hub_dir_listener.publish(formatMsg(id, "fwd"));
    }
    ffwd = function (id) {
      hub_dir_listener.publish(formatMsg(id, "ffwd"));
    }
    bwd = function (id) {
      hub_dir_listener.publish(formatMsg(id, "bwd"));
    }
    fbwd = function (id) {
      hub_dir_listener.publish(formatMsg(id, "fbwd"));
    }
    veerl = function (id) {
      hub_dir_listener.publish(formatMsg(id, "veerl"));
    }
    veerr = function (id) {
      hub_dir_listener.publish(formatMsg(id, "veerr"));
    }
    pivotl = function (id) {
      hub_dir_listener.publish(formatMsg(id, "pivotl"));
    }
    pivotr = function (id) {
      hub_dir_listener.publish(formatMsg(id, "pivotr"));
    }

  </script>
</head>

<body>
  <h1>Simple ROS User Interface</h1>
  <p>Connection status: <span id="status">NOT CONNECTED</span></p>
  <p>Last /txt_msg received: <span id="msg"></span></p>
  <button onclick="stop('0')" class="stop">STOP ALL</button>
  <button onclick="toggle('0')" class="auto">AUTO ALL</button>

  <div class="statuses">
    <div class="chair_monitor" id="1">
      <h2>Chair 1</h2>
      <div class="status o" id="1status">
        OFFLINE
      </div>
      <br>
      <div class="chair_control">
        <div class="directions">
          <button class="auto" id="1" onclick="toggle(this.id)">AUTO</button>
          <br>
          <button id="1" onclick="ffwd(this.id)">â¤Š</button>
          <button id="1" onclick="fwd(this.id)">â†‘</button>
          <div>
            <button id="1" onclick="pivotl(this.id)">âŸ²</button>
            <button id="1" onclick="veerl(this.id)">â¬‰</button>
            <button id="1" onclick="stop(this.id)">ðŸ›‘</button>
            <button id="1" onclick="veerr(this.id)">â¬ˆ</button>
            <button id="1" onclick="pivotr(this.id)">âŸ³</button>
          </div>
          <button id="1" onclick="bwd(this.id)">â†“</button>
          <button id="1" onclick="fbwd(this.id)">â¤‹</button>
        </div>
        <br>
        <button id="1" onclick="start(this.id)">START</button>
        <button id="1" onclick="stop(this.id)" class="stop">STOP</button>
        <br>
        <form id="1custom_handwritten" class="handwritten_form" onsubmit="return submitForm(event);">
          <label for="custom_handwritten">Custom: </label>
            <input type="text" id="custom_handwritten" name="custom_handwritten">
            <button type="submit" class="submit_button">Send</button>
          </form>
      </div>
    </div>
    <div class="chair_monitor" id="3">
      <h2>Chair 3</h2>
      <div class="status o" id="3status">
        OFFLINE
      </div>
      <br>
      <div class="chair_control">
        <div class="directions">
          <button class="auto" id="3" onclick="toggle(this.id)">AUTO</button>
          <br>
          <button id="3" onclick="ffwd(this.id)">â¤Š</button>
          <button id="3" onclick="fwd(this.id)">â†‘</button>
          <div>
            <button id="3" onclick="pivotl(this.id)">âŸ²</button>
            <button id="3" onclick="veerl(this.id)">â¬‰</button>
            <button id="3" onclick="stop(this.id)">ðŸ›‘</button>
            <button id="3" onclick="veerr(this.id)">â¬ˆ</button>
            <button id="3" onclick="pivotr(this.id)">âŸ³</button>
          </div>
          <button id="3" onclick="bwd(this.id)">â†“</button>
          <button id="3" onclick="fbwd(this.id)">â¤‹</button>
        </div>
        <br>
        <button id="3" onclick="start(this.id)">START</button>
        <button id="3" onclick="stop(this.id)" class="stop">STOP</button>
        <br>
        <form id="3custom_handwritten" class="handwritten_form" onsubmit="return submitForm(event);">
          <label for="custom_handwritten">Custom: </label>
            <input type="text" id="custom_handwritten" name="custom_handwritten">
            <button type="submit" class="submit_button">Send</button>
          </form>
      </div>
    </div>
    <div class="chair_monitor" id="4">
      <h2>Chair 4</h2>
      <div class="status o" id="4status">
        OFFLINE
      </div>
      <br>
      <div class="chair_control">
        <div class="directions">
          <button class="auto" id="4" onclick="toggle(this.id)">AUTO</button>
          <br>
          <button id="4" onclick="ffwd(this.id)">â¤Š</button>
          <button id="4" onclick="fwd(this.id)">â†‘</button>
          <div>
            <button id="4" onclick="pivotl(this.id)">âŸ²</button>
            <button id="4" onclick="veerl(this.id)">â¬‰</button>
            <button id="4" onclick="stop(this.id)">ðŸ›‘</button>
            <button id="4" onclick="veerr(this.id)">â¬ˆ</button>
            <button id="4" onclick="pivotr(this.id)">âŸ³</button>
          </div>
          <button id="4" onclick="bwd(this.id)">â†“</button>
          <button id="4" onclick="fbwd(this.id)">â¤‹</button>
        </div>
        <br>
        <button id="4" onclick="start(this.id)">START</button>
        <button id="4" onclick="stop(this.id)" class="stop">STOP</button>
        <br>
        <form id="4custom_handwritten" class="handwritten_form" onsubmit="return submitForm(event);">
          <label for="custom_handwritten">Custom: </label>
            <input type="text" id="custom_handwritten" name="custom_handwritten">
            <button type="submit" class="submit_button">Send</button>
          </form>
      </div>
    </div>
    <!-- <div class="chair_monitor backup" id="backup">
      <h2>Chair 4 (backup)</h2>
      <div class="status offline">
        OFFLINE
      </div>
    </div> -->
  </div>
</body>

</html>
